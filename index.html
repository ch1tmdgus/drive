<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>N4C드라이브</title>
  <style>
    /* 버튼 간 여백 추가 */
    .file-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }

    /* 버튼 숨기기 */
    .file-item button {
      display: none;
      /* Initially hide buttons */
    }

    /* 버튼 표시하기 */
    .file-item:hover button {
      display: inline;
      /* Show buttons on hover */

    }


    .file-item span {
      margin-right: 20px;
    }

    .file-item button {
      margin-left: 10px;
    }

    .file-size {
      font-size: 0.9em;
      color: gray;
      margin-left: 10px;
    }

    /* 드래그 앤 드롭 영역 스타일 */
    #dropArea {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      color: #ccc;
      margin-bottom: 20px;
      cursor: pointer;
    }

    #dropArea.dragover {
      border-color: #000;
      color: #000;
    }

    /* 스토리지 사용량 스타일 */
    #storageUsage {
      margin-top: 20px;
      font-size: 1.1em;
      font-weight: bold;
    }

    /* 선택된 파일 이름 스타일 */
    #selectedFileName {
      margin-top: 10px;
      font-size: 1em;
      color: blue;
    }
  </style>
</head>

<body>
  <h1>노빠꾸 클라우드</h1>

  <!-- 드래그 앤 드롭 영역 -->
  <div id="dropArea">파일을 여기에 드래그 앤 드롭 하세요</div>

  <!-- 수동 파일 선택 및 업로드 버튼 -->
  <input type="file" id="fileInput" style="display:none;" />
  <button id="selectFileButton">파일 선택하기</button>
  <button onclick="uploadFile()">업로드</button>

  <!-- 선택된 파일 이름 표시 -->
  <div id="selectedFileName">선택된 파일: 없음</div>

  <br><br>

  <!-- 업로드된 파일 목록 표시 -->
  <h2>업로드된 파일들</h2>
  <button onclick="listFiles()">새로고침하기</button>
  <button onclick="createNewFolder()">새로운 폴더 생성</button> <!-- 폴더 생성 버튼 -->
  <ul id="fileList"></ul>

  <!-- 스토리지 사용량 표시 -->
  <div id="storageUsage">사용된 스토리지: 0 MB / 1GB</div>

  <!-- Supabase CDN 추가 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    // Supabase 클라이언트 설정
    document.addEventListener('DOMContentLoaded', function () {
      const supabaseUrl = 'https://znwsvdurindumxattjet.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpud3N2ZHVyaW5kdW14YXR0amV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY3MDgwNzIsImV4cCI6MjA0MjI4NDA3Mn0.nF4-Y5XNO-rwuVmt9dq3BmOTzMkLtCcFUoD7EvjqK0Y'; // Replace with your actual Supabase key
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const bucketName = 'drive';
      const maxStorageMB = 1; // 최대 스토리지 용량 (GB)

      let selectedFile = null;
      let totalUsedStorage = 0;

      const fileInput = document.getElementById('fileInput');
      const dropArea = document.getElementById('dropArea');
      const selectFileButton = document.getElementById('selectFileButton');

      // 파일 선택 버튼 클릭 시 파일 선택기 열기
      selectFileButton.addEventListener('click', () => {
        fileInput.click();
      });

      // 파일 수동 선택 이벤트 리스너
      fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length) {
          selectedFile = files[0];
          document.getElementById('selectedFileName').innerText = `선택된 파일: ${selectedFile.name}`;
        }
      });

      // 드래그 앤 드롭 이벤트 리스너
      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('dragover');
      });

      dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover');
      });

      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length) {
          selectedFile = files[0];
          document.getElementById('selectedFileName').innerText = `선택된 파일: ${selectedFile.name}`;
        }
      });

      // 파일 크기를 KB 또는 MB로 변환하는 함수
      function formatFileSize(size) {
        if (size >= 1048576) { // 1MB 이상일 경우
          return (size / 1048576).toFixed(2) + ' MB';
        } else if (size >= 1024) {
          return (size / 1024).toFixed(2) + ' KB';
        } else {
          return size + ' bytes';
        }
      }

      // 스토리지 사용량 업데이트 함수
      function updateStorageUsage() {
        const storageUsage = document.getElementById('storageUsage');
        storageUsage.innerText = `사용된 스토리지: ${totalUsedStorage.toFixed(2)} MB / ${maxStorageMB} GB`;
      }

      // 파일 목록 조회 함수
      // 파일 목록 조회 함수
      window.listFiles = async function () {
        try {
          const { data, error } = await supabase
            .storage
            .from(bucketName)
            .list('', { limit: 100 });

          if (error) {
            console.error('Error fetching file list:', error.message);
            alert('Error fetching file list: ' + error.message);
            return;
          }

          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          totalUsedStorage = 0;

          data.forEach(file => {
            const listItem = document.createElement('li');
            listItem.classList.add('file-item');

            if (file.metadata && file.metadata.size !== undefined) {
              // 파일인 경우 처리
              const fileSizeFormatted = formatFileSize(file.metadata.size);
              totalUsedStorage += file.metadata.size / 1048576;

              listItem.innerHTML = `
                    <span>${file.name}</span>
                    <span class="file-size">(${fileSizeFormatted})</span>
                    <button onclick="downloadFileDirect('${file.name}')">다운로드</button>
                    <button onclick="renameFile('${file.name}')">이름 수정</button>
                    <button onclick="deleteFile('${file.name}')">삭제</button>
                `;
            } else {
              // 폴더인 경우 처리
              listItem.innerHTML = `
                    <span>${file.name} (폴더)</span>
                    <button onclick="uploadToFolder('${file.name}')">업로드</button>
                    <button onclick="deleteFolder('${file.name}')">폴더 삭제</button>
                `;
            }

            fileList.appendChild(listItem);
          });

          updateStorageUsage();
        } catch (e) {
          console.error('Unexpected error during file listing:', e);
          alert('Unexpected error occurred while fetching file list.');
        }
      };

      // 파일 업로드 함수
      window.uploadFile = async function () {
        if (!selectedFile) {
          alert('파일을 선택해 주세요.');
          return;
        }f

        const sanitizedFileName = selectedFile.name.replace(/[^a-zA-Z0-9._-]/g, '_');
        const fileSize = formatFileSize(selectedFile.size);

        try {
          const { data, error } = await supabase
            .storage
            .from(bucketName)
            .upload(sanitizedFileName, selectedFile);

          if (error) {
            alert('Error uploading file: ' + error.message);
            return;
          }

          alert(`File uploaded successfully! (Size: ${fileSize})`);
          listFiles();
          selectedFile = null;
          document.getElementById('selectedFileName').innerText = "선택된 파일: 없음";
        } catch (e) {
          console.error('Unexpected error during file upload:', e);
          alert('Unexpected error occurred during file upload.');
        }
      };

      // 다운로드 함수
      window.downloadFileDirect = async function (fileName) {
        try {
          const { data, error } = await supabase
            .storage
            .from(bucketName)
            .download(fileName);

          if (error) {
            alert('Error downloading file: ' + error.message);
            return;
          }

          const url = window.URL.createObjectURL(data);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          console.error('Unexpected error during file download:', e);
          alert('Unexpected error occurred during file download.');
        }
      };

      // 파일 삭제 함수
      window.deleteFile = async function (fileName) {
        const confirmDelete = confirm(`정말 ${fileName} 파일을 삭제하시겠습니까?`);
        if (!confirmDelete) return;

        try {
          const { error } = await supabase
            .storage
            .from(bucketName)
            .remove([fileName]);

          if (error) {
            alert('Error deleting file: ' + error.message);
            return;
          }

          alert('파일이 삭제되었습니다.');
          listFiles();
        } catch (e) {
          console.error('Unexpected error during file deletion:', e);
          alert('Unexpected error occurred while deleting file.');
        }
      };

      // 새로운 폴더 생성 함수
      window.createNewFolder = async function () {
        const folderName = prompt('새로운 폴더 이름을 입력하세요:');
        if (!folderName) return;

        try {
          const { error } = await supabase
            .storage
            .from(bucketName)
            .createFolder(folderName);

          if (error) {
            alert('Error creating folder: ' + error.message);
            return;
          }

          alert('폴더가 생성되었습니다.');
          listFiles();
        } catch (e) {
          console.error('Unexpected error during folder creation:', e);
          alert('Unexpected error occurred while creating folder.');
        }
      };

      // 폴더 삭제 함수
      window.deleteFolder = async function (folderName) {
        const confirmDelete = confirm(`정말 ${folderName} 폴더를 삭제하시겠습니까?`);
        if (!confirmDelete) return;

        try {
          const { error } = await supabase
            .storage
            .from(bucketName)
            .remove([`${bucketName}/${folderName}`]);

          if (error) {
            alert('Error deleting folder: ' + error.message);
            return;
          }

          alert('폴더가 삭제되었습니다.');
          listFiles();
        } catch (e) {
          console.error('Unexpected error during folder deletion:', e);
          alert('Unexpected error occurred while deleting folder.');
        }
      };// 파일 이름 수정 함수
      window.renameFile = async function (fileName) {
        const newFileName = prompt(`새로운 파일 이름을 입력하세요(확장자 포함)[현재 이름: ${fileName}]:`);
        if (!newFileName) return;

        try {
          const { error } = await supabase
            .storage
            .from(bucketName)
            .move(fileName, newFileName);

          if (error) {
            alert('오류 발생 ' + error.message);
            return;
          }

          alert('파일 이름이 수정되었습니다.');
          listFiles();
        } catch (e) {
          console.error('Unexpected error during file renaming:', e);
          alert('Unexpected error occurred while renaming file.');
        }
      };

      // 폴더에 파일 업로드 함수
      window.uploadToFolder = async function (folderName) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.onchange = async (e) => {
          const files = e.target.files;
          if (files.length) {
            const fileToUpload = files[0];
            const sanitizedFileName = `${folderName}/${fileToUpload.name}`;
            try {
              const { error } = await supabase
                .storage
                .from(bucketName)
                .upload(sanitizedFileName, fileToUpload);

              if (error) {
                alert('Error uploading file to folder: ' + error.message);
                return;
              }

              alert('파일이 폴더에 업로드되었습니다.');
              listFiles();
            } catch (e) {
              console.error('Unexpected error during folder upload:', e);
              alert('Unexpected error occurred during file upload.');
            }
          }
        };
        fileInput.click();
      };

      // 파일 목록 초기 로드
      listFiles();
    });
  </script>
</body>

</html>
